<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Posodobitve - Ceniki.si</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .updates-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: #1e293b;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .updates-container h2 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: #fff;
        }
        .update-item {
            background: #0f172a;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #f59e0b;
        }
        .update-item h3 {
            margin: 0 0 0.5rem;
            color: #fff;
        }
        .update-item p {
            margin: 0;
            color: #94a3b8;
        }
        .update-item img {
            max-width: 100%;
            height: auto;
            margin-top: 1rem;
            border-radius: 6px;
            cursor: pointer;
        }
        .update-item .action-buttons {
            margin-top: 1rem;
        }
        .update-item .action-buttons button, .update-item .action-buttons a {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 0.5rem;
            transition: 0.3s;
            text-decoration: none;
        }
        .update-item .action-buttons .accept-btn {
            background: #22c55e;
            color: #fff;
        }
        .update-item .action-buttons .reject-btn {
            background: #ef4444;
            color: #fff;
        }
        /* Modal stil */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9);
        }
        .modal-content-image {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 700px;
        }
        #caption {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 700px;
            text-align: center;
            color: #ccc;
            padding: 10px 0;
            height: 150px;
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <header>
        <h1><a href="index.html" style="text-decoration: none; color: inherit;">üçΩ Ceniki.si <span>‚Äì ‚ÄúWaze za restavracije‚Äù</span></a></h1>
        <nav id="auth-nav">
            <a href="prevzemirestavracijo.html" class="claim">üè¢ Prevzemi restavracijo</a>
            <a href="login.html" class="login">üîë Prijava</a>
            <a href="registracija.html" class="register">üìå Registracija</a>
        </nav>
    </header>

    <div class="updates-container">
        <h2>ƒåakajoƒçe posodobitve</h2>
        <div id="updatesList">
            <p style="text-align: center; color: #94a3b8;">Nalaganje posodobitev...</p>
        </div>
    </div>
    
    <!-- Modalno okno za poveƒçanje slike -->
    <div id="imageModal" class="modal">
        <span class="modal-close">&times;</span>
        <img class="modal-content-image" id="modalImage">
        <div id="caption"></div>
    </div>

    <script type="module">
        // Te nastavitve so posodobljene z vrednostmi iz va≈°e slike
        const firebaseConfig = {
            apiKey: "AIzaSyB5LckjRosY5QxDYLs9VP0dOsLl-YRuOes",
            authDomain: "ceniki-fcf67.firebaseapp.com",
            projectId: "ceniki-fcf67",
            storageBucket: "ceniki-fcf67.appspot.com",
            messagingSenderId: "617986018856",
            appId: "1:617986018856:web:45799e02eb02d8f6e5b3e5d"
        };
        
        // Firebase init
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        let loggedInUser = null;
        
        // Funkcija za nalaganje posodobitev
        async function loadUpdates() {
            const updatesList = document.getElementById('updatesList');
            updatesList.innerHTML = '<p style="text-align: center; color: #94a3b8;">Nalaganje posodobitev...</p>';
            
            try {
                const q = query(collection(db, "updates"), where("status", "==", "pending"));
                const querySnapshot = await getDocs(q);
                
                updatesList.innerHTML = '';
                if (querySnapshot.empty) {
                    updatesList.innerHTML = '<p style="text-align: center; color: #94a3b8;">Ni ƒçakajoƒçih posodobitev.</p>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const update = doc.data();
                        const updateItem = document.createElement('div');
                        updateItem.className = 'update-item';
                        updateItem.innerHTML = `
                            <h3>${update.restaurant_name} - ${update.item_name}</h3>
                            <p><strong>Nova cena:</strong> ${update.new_price} ‚Ç¨</p>
                            <p>Predlagal: ${update.submitted_by}</p>
                            <img src="${update.image_path}" alt="Prilo≈æena slika" data-fullsrc="${update.image_path}">
                            <div class="action-buttons">
                                <a href="${update.image_path}" download class="accept-btn">Prenesi sliko</a>
                                <button class="accept-btn" data-id="${doc.id}">Sprejmi</button>
                                <button class="reject-btn" data-id="${doc.id}">Zavrni</button>
                            </div>
                        `;
                        updatesList.appendChild(updateItem);
                    });
                }
            } catch (error) {
                console.error('Napaka pri nalaganju posodobitev:', error);
                updatesList.innerHTML = '<p style="text-align: center; color: #ef4444;">' + error.message + '</p>';
            }
        }
        
        // Funkcija za obravnavanje gumbov "Sprejmi" in "Zavrni"
        document.addEventListener('click', async (e) => {
            if (!loggedInUser || (loggedInUser.role !== 'admin' && loggedInUser.role !== 'verified')) {
                return; // Prepreƒçi nepoobla≈°ƒçenim uporabnikom interakcijo
            }
            
            if (e.target.classList.contains('accept-btn') && e.target.tagName === 'BUTTON') {
                const updateId = e.target.dataset.id;
                try {
                    await updateDoc(doc(db, "updates", updateId), { status: "approved" });
                    alert('Posodobitev sprejeta!');
                    loadUpdates();
                } catch (error) {
                    console.error('Napaka pri sprejemanju posodobitve:', error);
                    alert('Napaka pri sprejemanju posodobitve.');
                }
            }
            if (e.target.classList.contains('reject-btn')) {
                const updateId = e.target.dataset.id;
                try {
                    await updateDoc(doc(db, "updates", updateId), { status: "rejected" });
                    alert('Posodobitev zavrnjena.');
                    loadUpdates();
                } catch (error) {
                    console.error('Napaka pri zavraƒçanju posodobitve:', error);
                    alert('Napaka pri zavraƒçanju posodobitve.');
                }
            }
        });

        // Modal logic for image
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const modalClose = document.querySelector('.modal-close');
        
        document.addEventListener('click', (e) => {
            if (e.target.tagName === 'IMG' && e.target.closest('.update-item')) {
                imageModal.style.display = 'block';
                modalImage.src = e.target.dataset.fullsrc;
            }
        });

        modalClose.onclick = () => {
            imageModal.style.display = 'none';
        };

        window.onclick = (e) => {
            if (e.target === imageModal) {
                imageModal.style.display = 'none';
            }
        };

        // Obravnava stanja prijave in nalaganje strani
        const authNav = document.getElementById('auth-nav');
        onAuthStateChanged(auth, async (user) => {
            authNav.innerHTML = '';
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                const userData = userDoc.data();
                loggedInUser = {
                    username: userData.username,
                    role: userData.role
                };
                
                let usernameDisplay = loggedInUser.username;
                let profileClass = "";
                let adminNavHTML = "";

                if (loggedInUser.role === 'admin' || loggedInUser.role === 'verified') {
                    adminNavHTML = `<a href="updates.html" class="claim">üì• Posodobitve</a>`;
                    if (loggedInUser.role === 'admin') {
                        adminNavHTML += `<a href="claim-requests.html" class="claim" style="background:#facc15;">üì¶ Zahtevki</a>`;
                    }
                }

                if (loggedInUser.role === 'admin') {
                    usernameDisplay = "üë§ " + loggedInUser.username;
                    profileClass = "admin-name";
                }
                
                authNav.innerHTML = `
                    <div class="profile-nav">
                        ${adminNavHTML}
                        <a href="#" class="profile-link ${profileClass}">${usernameDisplay}</a>
                        <a href="#" id="logout-btn" class="login">Odjava</a>
                    </div>
                `;
                
                document.getElementById('logout-btn').addEventListener('click', async () => {
                    await signOut(auth);
                    window.location.href = 'index.html';
                });
                
                // Nalo≈æi posodobitve, ƒçe je uporabnik administrator ali verificiran
                if (loggedInUser.role === 'admin' || loggedInUser.role === 'verified') {
                    loadUpdates();
                } else {
                    window.location.href = 'index.html'; // Preusmeri neavtorizirane
                }

            } else {
                loggedInUser = null;
                authNav.innerHTML = `
                    <a href="prevzemirestavracijo.html" class="claim">üè¢ Prevzemi restavracijo</a>
                    <a href="login.html" class="login">üîë Prijava</a>
                    <a href="registracija.html" class="register">üìå Registracija</a>
                `;
                 window.location.href = 'index.html'; // Preusmeri neprijavljene
            }
        });
    </script>
</body>
</html>
