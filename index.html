<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ceniki.si</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #1e293b;
            margin: 5% auto;
            padding: 2rem;
            border: 1px solid #334155;
            width: 80%;
            max-width: 500px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: white;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-content input, .modal-content button {
            width: 100%;
            padding: 0.75rem;
            margin-top: 1rem;
            border-radius: 6px;
            border: 1px solid #334155;
            background: #0f172a;
            color: #e2e8f0;
            box-sizing: border-box;
        }
        .modal-content button {
            background: #3b82f6;
            cursor: pointer;
        }
        .modal-content button:hover {
            background: #60a5fa;
        }
    </style>
</head>
<body>
    <header>
        <h1><a href="index.html" style="text-decoration: none; color: inherit;">üçΩ Ceniki.si <span>‚Äì ‚ÄúWaze za restavracije‚Äù</span></a></h1>
        <nav id="auth-nav">
            <a href="prevzemirestavracijo.html" class="claim">üè¢ Prevzemi restavracijo</a>
            <a href="login.html" class="login">üîë Prijava</a>
            <a href="registracija.html" class="register">üìå Registracija</a>
        </nav>
    </header>

    <section class="hero">
        <h2>Najdi cenike v bli≈æini ‚Äî hitro, pregledno in a≈æurno</h2>
        <p>Prebrskaj ponudbo, primerjaj cene jedi in pijaƒç ter odpri najbolj≈°o izbiro.</p>
        <div class="filters">
            <input type="text" id="searchBox" placeholder="I≈°ƒçi: ime restavracije ali jed (npr. 'pizza')" oninput="renderRestaurants()" />
            <select><option>Vse kategorije</option><option>Pizza</option><option>Burger</option></select>
            <select><option>Vsi cenovni razredi</option><option>‚Ç¨</option><option>‚Ç¨‚Ç¨</option><option>‚Ç¨‚Ç¨‚Ç¨</option></select>
            <button>Moja lokacija</button>
        </div>
    </section>

    <section class="content">
        <div id="restaurantList"></div>
        <div id="map"></div>
    </section>

    <!-- Modalno okno za posodobitve cen -->
    <div id="updateModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Predlagaj posodobitev za <span id="modalRestaurantName"></span></h2>
            <form id="updateForm">
                <input type="hidden" id="modalRestaurantInput" name="restaurant_name">
                <label for="item_name">Ime izdelka:</label>
                <input type="text" id="item_name" name="item_name" required>
                <label for="new_price">Nova cena (‚Ç¨):</label>
                <input type="number" id="new_price" name="new_price" step="0.01" required>
                <label for="photo">Nalo≈æi sliko cenika/raƒçuna:</label>
                <input type="file" id="photo" name="photo" accept="image/*" required>
                <button type="submit">Po≈°lji posodobitev</button>
            </form>
        </div>
    </div>

    <script type="module">
        // Te nastavitve so posodobljene z vrednostmi iz va≈°e slike
        const firebaseConfig = {
            apiKey: "AIzaSyB5LckjRosY5QxDYLs9VP0dOsLl-YRuOes",
            authDomain: "ceniki-fcf67.firebaseapp.com",
            projectId: "ceniki-fcf67",
            storageBucket: "ceniki-fcf67.appspot.com",
            messagingSenderId: "617986018856",
            appId: "1:617986018856:web:45799e02eb02d8f6e5b3e5d"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Map data from Firestore
        let restaurants = [
            {name:"Burger Postaja", address:"Trubarjeva 45, Ljubljana", lat:46.056, lng:14.505, category:"Burger", price:"‚Ç¨‚Ç¨", tags:["cheeseburger","sweet potato fries"], distance:"98 m", rating:4.2},
            {name:"Azija Express", address:"Dunajska 56, Ljubljana", lat:46.065, lng:14.51, category:"Azijska", price:"‚Ç¨‚Ç¨", tags:["ramen","wok","sushi"], distance:"524 m", rating:4.0},
            {name:"≈Ωar pri Mostu", address:"Njego≈°eva 12, Ljubljana", lat:46.07, lng:14.52, category:"Grill", price:"‚Ç¨‚Ç¨", tags:["ƒçevapƒçiƒçi","pljeskavica"], distance:"607 m", rating:4.3},
            {name:"Pizzerija Trg 3", address:"Stari trg 3, Ljubljana", lat:46.055, lng:14.507, category:"Pizza", price:"‚Ç¨‚Ç¨", tags:["pizza margherita","peka na drva","dostava"], distance:"649 m", rating:4.5}
        ];

        let map = L.map('map').setView([46.056,14.505], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:"¬© OpenStreetMap" }).addTo(map);

        function renderRestaurants(){
            const list = document.getElementById('restaurantList');
            list.innerHTML = '';
            const query = document.getElementById('searchBox').value.toLowerCase();
            restaurants.filter(r => r.name.toLowerCase().includes(query) || r.tags.some(t=>t.includes(query))).forEach(r => {
                let div = document.createElement('div');
                div.className = 'restaurant';
                div.innerHTML = `
                    <h3>${r.name}</h3>
                    <p>${r.address} ‚Ä¢ ${r.category} ‚Ä¢ ${r.price}</p>
                    <p>${r.tags.map(t=>`<span>#${t}</span>`).join(' ')}</p>
                    <p><b>od ${Math.round(Math.random()*5+5)},00 ‚Ç¨</b> ‚Ä¢ ${r.distance} ‚Ä¢ ‚≠ê ${r.rating}</p>
                    <button class="update-price-btn" data-restaurant="${r.name}">Posodobi cenik</button>
                `;
                list.appendChild(div);
            });
        }

        restaurants.forEach(r => {
            L.marker([r.lat,r.lng]).addTo(map).bindPopup(`<b>${r.name}</b><br>${r.address}`);
        });

        renderRestaurants();
        
        const authNav = document.getElementById('auth-nav');
        let loggedInUser = null;

        onAuthStateChanged(auth, async (user) => {
            authNav.innerHTML = ''; // Poƒçisti navigacijo ob spremembi statusa
            if (user) {
                // Uporabnik je prijavljen
                const userDoc = await getDoc(doc(db, "users", user.uid));
                const userData = userDoc.data();
                loggedInUser = {
                    username: userData.username,
                    role: userData.role
                };
                
                let usernameDisplay = loggedInUser.username;
                let profileClass = "";
                let adminNavHTML = "";

                if (loggedInUser.role === 'admin' || loggedInUser.role === 'verified') {
                    adminNavHTML = `<a href="updates.html" class="claim">üì• Posodobitve</a>`;
                }

                if (loggedInUser.role === 'admin') {
                    usernameDisplay = "üë§ " + loggedInUser.username;
                    profileClass = "admin-name";
                }
                
                authNav.innerHTML = `
                    <div class="profile-nav">
                        ${adminNavHTML}
                        <a href="#" class="profile-link ${profileClass}">${usernameDisplay}</a>
                        <a href="#" id="logout-btn" class="login">Odjava</a>
                    </div>
                `;
                
                document.getElementById('logout-btn').addEventListener('click', async () => {
                    await signOut(auth);
                    window.location.reload();
                });

            } else {
                // Uporabnik ni prijavljen
                loggedInUser = null;
                authNav.innerHTML = `
                    <a href="prevzemirestavracijo.html" class="claim">üè¢ Prevzemi restavracijo</a>
                    <a href="login.html" class="login">üîë Prijava</a>
                    <a href="registracija.html" class="register">üìå Registracija</a>
                `;
            }
        });

        // Modal logic
        const updateModal = document.getElementById('updateModal');
        const updateForm = document.getElementById('updateForm');
        const closeButton = document.querySelector('.close-button');
        const modalRestaurantName = document.getElementById('modalRestaurantName');
        const modalRestaurantInput = document.getElementById('modalRestaurantInput');
        
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('update-price-btn')) {
                const restaurantName = e.target.dataset.restaurant;
                modalRestaurantName.textContent = restaurantName;
                modalRestaurantInput.value = restaurantName;
                updateModal.style.display = 'block';
            }
        });
        
        closeButton.onclick = () => {
            updateModal.style.display = 'none';
        };
        
        window.onclick = (e) => {
            if (e.target === updateModal) {
                updateModal.style.display = 'none';
            }
        };

        updateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(updateForm);
            
            const fileInput = document.getElementById('photo');
            const file = fileInput.files[0];

            if (file) {
                try {
                    const storageRef = ref(storage, `updates/${Date.now()}_${file.name}`);
                    await uploadBytes(storageRef, file);
                    const photoURL = await getDownloadURL(storageRef);

                    // Pove≈æite se z Firestore (ne s Flask backendom)
                    const updatesRef = doc(db, "updates", Date.now().toString());
                    await setDoc(updatesRef, {
                        restaurant_name: formData.get('restaurant_name'),
                        item_name: formData.get('item_name'),
                        new_price: parseFloat(formData.get('new_price')),
                        submitted_by: loggedInUser ? loggedInUser.username : 'Gost',
                        image_path: photoURL,
                        status: 'pending'
                    });
                    
                    alert('Predlog posodobitve uspe≈°no oddan!');
                    updateModal.style.display = 'none';
                    updateForm.reset();
                } catch (error) {
                    console.error('Napaka pri oddaji posodobitve:', error);
                    alert('Pri≈°lo je do napake pri oddaji posodobitve.');
                }
            } else {
                alert('Prosimo, prilo≈æite sliko.');
            }
        });
    </script>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</body>
</html>
